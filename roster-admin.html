<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Roster Admin ‚Äì CUOnline</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f4f5f7;
      color: #1b1e28;
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
      background: #fff;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 20px;
      font-size: 24px;
      color: #363763;
    }
    label {
      display: block;
      margin: 16px 0 6px;
      font-weight: 700;
      font-size: 14px;
    }
    input, textarea, select {
      width: 100%;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
    }
    input:focus, textarea:focus, select:focus {
      border-color: #363763;
      box-shadow: 0 0 0 3px rgba(54,55,99,0.1);
    }
    textarea {
      min-height: 200px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
    }
    button {
      margin-top: 20px;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      background: linear-gradient(180deg, #1e1f4a, #363763);
      color: #fff;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover {
      filter: brightness(1.1);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .status {
      margin-top: 16px;
      padding: 12px;
      border-radius: 8px;
      font-size: 14px;
      display: none;
    }
    .status.success {
      background: rgba(34,194,95,0.1);
      color: #16a34a;
      border: 1px solid rgba(34,194,95,0.3);
      display: block;
    }
    .status.error {
      background: rgba(189,56,80,0.1);
      color: #dc2626;
      border: 1px solid rgba(189,56,80,0.3);
      display: block;
    }
    .preview {
      margin-top: 16px;
      padding: 12px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }
    .preview pre {
      margin: 0;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üìã Roster Admin</h1>
    <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">
      Parse CUOnline table and push roster to backend
    </p>

    <label for="apiUrl">Roster API URL</label>
    <input type="url" id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" value="https://script.google.com/macros/s/AKfycbzjesO7reTJYhIkBoJHuB1PAW8UDGgsZ1cnukgC5zYBHQkzl6sougIan7Btc0_TOUJQ/exec">

    <label for="secret">Secret Key</label>
    <input type="password" id="secret" value="k9F@3xQp7L_92aZ!rT">

    <label for="courseId">Course ID</label>
    <input type="text" id="courseId" placeholder="30000 or CSC462" value="30000">

    <label for="section">Section</label>
    <select id="section">
      <option value="NA">NA (No section)</option>
      <option value="A">A</option>
      <option value="B">B</option>
      <option value="C">C</option>
    </select>

    <label for="rosterText">Paste CUOnline Table (Sr#, Reg.No., Name)</label>
    <textarea id="rosterText" placeholder="Paste the table from CUOnline here...
Example:
1	FA22-BCS-008	AQSA HANIF
2	FA22-BCS-078	MUHAMMAD SALMAN TAYYAB
3	SP23-BCS-006	ABEERA EJAZ"></textarea>

    <button id="parseBtn">Parse & Preview</button>
    
    <div id="preview" class="preview" style="display:none;"></div>

    <button id="pushBtn" style="display:none;">‚úì Push Roster to Backend</button>

    <div id="status" class="status"></div>
  </div>

  <script>
    const apiUrlInput = document.getElementById('apiUrl');
    const secretInput = document.getElementById('secret');
    const courseIdInput = document.getElementById('courseId');
    const sectionInput = document.getElementById('section');
    const rosterTextInput = document.getElementById('rosterText');
    const parseBtn = document.getElementById('parseBtn');
    const pushBtn = document.getElementById('pushBtn');
    const previewDiv = document.getElementById('preview');
    const statusDiv = document.getElementById('status');

    let parsedPayload = null;

    function showStatus(message, type) {
      statusDiv.textContent = message;
      statusDiv.className = 'status ' + type;
    }

    function hideStatus() {
      statusDiv.style.display = 'none';
    }

    parseBtn.addEventListener('click', () => {
      hideStatus();
      previewDiv.style.display = 'none';
      pushBtn.style.display = 'none';

      const text = rosterTextInput.value.trim();
      if (!text) {
        showStatus('‚ö†Ô∏è Paste CUOnline table first', 'error');
        return;
      }

      const courseId = courseIdInput.value.trim();
      const section = sectionInput.value;

      if (!courseId) {
        showStatus('‚ö†Ô∏è Enter Course ID', 'error');
        return;
      }

      // Parse lines
      const lines = text.split('\n').map(l => l.trim()).filter(l => l);
      const roster = [];

      for (const line of lines) {
        // Split by tabs or multiple spaces
        const parts = line.split(/\t+|\s{2,}/).map(p => p.trim()).filter(p => p);
        
        if (parts.length < 3) continue;

        const sr = parts[0];
        const regNo = parts[1];
        const name = parts.slice(2).join(' ');

        // Skip header row
        if (regNo.toLowerCase().includes('reg') || regNo.toLowerCase() === 'no.') continue;

        // Basic validation
        if (!regNo || !name) continue;

        roster.push({
          regNo: regNo,
          displayReg: regNo, // Same for now (you can customize if needed)
          name: name.toUpperCase()
        });
      }

      if (!roster.length) {
        showStatus('‚ö†Ô∏è No valid students found. Check format.', 'error');
        return;
      }

      parsedPayload = {
        type: "roster",
        courseId: courseId,
        section: section,
        extractedAt: new Date().toISOString(),
        totalStudents: roster.length,
        roster: roster
      };

      previewDiv.innerHTML = '<pre>' + JSON.stringify(parsedPayload, null, 2) + '</pre>';
      previewDiv.style.display = 'block';
      pushBtn.style.display = 'block';

      showStatus(`‚úÖ Parsed ${roster.length} students. Review and push.`, 'success');
    });

    pushBtn.addEventListener('click', async () => {
      if (!parsedPayload) {
        showStatus('‚ö†Ô∏è Parse roster first', 'error');
        return;
      }

      const apiUrl = apiUrlInput.value.trim();
      const secret = secretInput.value.trim();

      if (!apiUrl || !secret) {
        showStatus('‚ö†Ô∏è API URL and Secret required', 'error');
        return;
      }

      pushBtn.disabled = true;
      showStatus('‚è≥ Pushing roster to backend...', 'success');

      try {
        const url = apiUrl + '?secret=' + encodeURIComponent(secret);
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(parsedPayload),
          mode: 'no-cors' // Apps Script doesn't return proper CORS headers
        });

        // no-cors = can't read response, assume success
        showStatus(`‚úÖ Roster pushed! (${parsedPayload.totalStudents} students)`, 'success');
        
      } catch (err) {
        showStatus('‚ùå Error: ' + err.message, 'error');
        pushBtn.disabled = false;
      }
    });
  </script>
</body>
</html>