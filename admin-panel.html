<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel ‚Äì Attendance System</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    .header {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      margin-bottom: 24px;
    }
    .header h1 {
      font-size: 28px;
      color: #1a202c;
      margin-bottom: 8px;
    }
    .header p {
      color: #718096;
      font-size: 14px;
    }
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .tab {
      background: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      color: #4a5568;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      min-height: 400px;
    }
    .tab-pane {
      display: none;
    }
    .tab-pane.active {
      display: block;
    }
    .card {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 16px;
    }
    .card h3 {
      color: #2d3748;
      font-size: 18px;
      margin-bottom: 12px;
    }
    .card p {
      color: #718096;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 16px;
    }
    .btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }
    .btn.secondary {
      background: #e2e8f0;
      color: #2d3748;
    }
    .btn.danger {
      background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
    }
    .code-block {
      background: #1a202c;
      color: #68d391;
      padding: 16px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      overflow-x: auto;
      margin-top: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .form-group {
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-weight: 700;
      color: #2d3748;
      margin-bottom: 8px;
      font-size: 14px;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      font-family: inherit;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    .alert {
      padding: 16px;
      border-radius: 10px;
      margin-bottom: 20px;
      font-size: 14px;
    }
    .alert.success {
      background: rgba(72, 187, 120, 0.1);
      color: #2f855a;
      border: 1px solid rgba(72, 187, 120, 0.3);
    }
    .alert.error {
      background: rgba(245, 101, 101, 0.1);
      color: #c53030;
      border: 1px solid rgba(245, 101, 101, 0.3);
    }
    .alert.info {
      background: rgba(66, 153, 225, 0.1);
      color: #2c5282;
      border: 1px solid rgba(66, 153, 225, 0.3);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
    }
    table th,
    table td {
      text-align: left;
      padding: 12px;
      border-bottom: 1px solid #e2e8f0;
      font-size: 14px;
    }
    table th {
      font-weight: 700;
      color: #2d3748;
      background: #f7fafc;
    }
    table td {
      color: #4a5568;
    }
    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .badge.green {
      background: rgba(72, 187, 120, 0.15);
      color: #2f855a;
    }
    .badge.blue {
      background: rgba(66, 153, 225, 0.15);
      color: #2c5282;
    }
    .badge.red {
      background: rgba(245, 101, 101, 0.15);
      color: #c53030;
    }
    .copy-btn {
      position: relative;
      margin-top: 12px;
    }
    .instructions {
      background: #edf2f7;
      border-left: 4px solid #667eea;
      padding: 16px;
      border-radius: 8px;
      margin-top: 16px;
    }
    .instructions ol {
      margin-left: 20px;
      margin-top: 12px;
    }
    .instructions li {
      margin-bottom: 8px;
      color: #4a5568;
      font-size: 14px;
      line-height: 1.6;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .stat-card h4 {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 8px;
    }
    .stat-card .number {
      font-size: 36px;
      font-weight: 800;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üõ†Ô∏è Admin Panel</h1>
      <p>Attendance System Management Dashboard</p>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('scraper')">üì• Roster Scraper</button>
      <button class="tab" onclick="switchTab('rosters')">üìã View Rosters</button>
      <button class="tab" onclick="switchTab('unlock')">üîì Unlock Attendance</button>
      <button class="tab" onclick="switchTab('addStudent')">‚ûï Add Student</button>
      <button class="tab" onclick="switchTab('crs')">üë• Manage CRs</button>
    </div>

    <div class="content">
      <!-- TAB 1: ROSTER SCRAPER -->
      <div id="scraper" class="tab-pane active">
        <div class="card">
          <h3>üì• CUOnline Roster Scraper</h3>
          <p>Generate a bookmarklet to extract roster data directly from CUOnline attendance page and save to Drive.</p>
          
          <button class="btn" onclick="generateBookmarklet()">üõ†Ô∏è Generate Bookmarklet Code</button>

          <div id="bookmarkletOutput" style="display:none;">
            <div class="code-block" id="bookmarkletCode"></div>
            <button class="btn copy-btn" onclick="copyBookmarklet()">üìã Copy to Clipboard</button>
          </div>

          <div class="instructions">
            <strong>üí° How to use:</strong>
            <ol>
              <li>Click <b>"Generate Bookmarklet Code"</b> button above</li>
              <li>Copy the generated JavaScript code</li>
              <li>Open CUOnline and navigate to attendance page for a specific course/section</li>
              <li>Open browser DevTools (F12) ‚Üí Console tab</li>
              <li>Paste the code and press Enter</li>
              <li><b>Enter the section name when prompted</b> (e.g., A, B, C)</li>
              <li>Roster will be extracted and saved to Drive automatically</li>
            </ol>
          </div>
        </div>

        <div class="card">
          <h3>üìä Quick Stats</h3>
          <div class="grid">
            <div class="stat-card">
              <h4>Total Rosters</h4>
              <div class="number" id="totalRosters">-</div>
            </div>
            <div class="stat-card">
              <h4>Total Students</h4>
              <div class="number" id="totalStudents">-</div>
            </div>
            <div class="stat-card">
              <h4>Sections</h4>
              <div class="number" id="totalSections">-</div>
            </div>
          </div>
        </div>
      </div>

      <!-- TAB 2: VIEW ROSTERS -->
      <div id="rosters" class="tab-pane">
        <div class="card">
          <h3>üìã Synced Rosters</h3>
          <p>View all roster files stored in Drive (showing latest for each section)</p>
          <button class="btn" onclick="loadRosters()">üîÑ Refresh List</button>
          <div id="rostersList"></div>
        </div>
      </div>

      <!-- TAB 3: UNLOCK ATTENDANCE -->
      <div id="unlock" class="tab-pane">
        <div class="card">
          <h3>üîì Unlock Attendance</h3>
          <p>Allow CRs to edit previously submitted attendance</p>
          
          <div class="form-group">
            <label>Course ID</label>
            <input type="text" id="unlockCourseId" placeholder="30000" />
          </div>

          <div class="form-group">
            <label>Section</label>
            <select id="unlockSection">
              <option value="NA">NA</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>

          <div class="form-group">
            <label>Date</label>
            <input type="date" id="unlockDate" />
          </div>

          <button class="btn danger" onclick="unlockAttendance()">üîì Unlock</button>
          <div id="unlockStatus"></div>
        </div>
      </div>

      <!-- TAB 4: ADD STUDENT -->
      <div id="addStudent" class="tab-pane">
        <div class="card">
          <h3>‚ûï Add Student to Roster</h3>
          <p>Manually add a new student to an existing roster</p>
          
          <div class="form-group">
            <label>Course ID</label>
            <input type="text" id="addCourseId" placeholder="30000" />
          </div>

          <div class="form-group">
            <label>Section</label>
            <select id="addSection">
              <option value="NA">NA</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
            </select>
          </div>

          <div class="form-group">
            <label>Registration Number</label>
            <input type="text" id="addRegNo" placeholder="FA22-BCS-001" />
          </div>

          <div class="form-group">
            <label>Student Name</label>
            <input type="text" id="addName" placeholder="JOHN DOE" />
          </div>

          <button class="btn" onclick="addStudent()">‚ûï Add Student</button>
          <div id="addStatus"></div>
        </div>
      </div>

      <!-- TAB 5: MANAGE CRs -->
      <div id="crs" class="tab-pane">
        <div class="card">
          <h3>üë• CR Management</h3>
          <p>Assign CRs to sections and manage access control</p>
          
          <div class="form-group">
            <label>CR Email</label>
            <input type="email" id="crEmail" placeholder="cr@comsats.edu.pk" />
          </div>

          <div class="form-group">
            <label>Course ID</label>
            <input type="text" id="crCourseId" placeholder="30000" />
          </div>

          <div class="form-group">
            <label>Section</label>
            <select id="crSection">
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="NA">NA</option>
            </select>
          </div>

          <button class="btn" onclick="assignCR()">‚úÖ Assign CR</button>
          <div id="crStatus"></div>

          <table style="margin-top: 24px;">
            <thead>
              <tr>
                <th>Email</th>
                <th>Section</th>
                <th>Course</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="crList">
              <tr>
                <td colspan="4" style="text-align: center; color: #718096;">Click "Assign CR" to add CRs</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbwZigSx9Zr2y0qa10jcR5y8U3B5aOApVgwaAbo-fssmvB7Y7cf90LkNjvjjwhDtFA8G/exec';
    const SECRET = 'k9F@3xQp7L_92aZ!rT';

    // Switch tabs
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-pane').forEach(p => p.style.display = 'none');
      
      event.target.classList.add('active');
      document.getElementById(tabName).style.display = 'block';
      
      // Auto-load rosters when switching to rosters tab
      if (tabName === 'rosters') {
        loadRosters();
      }
    }

    // Generate bookmarklet with section extraction
    function generateBookmarklet() {
      const code = `(() => {
  const src = window.lstAttendanceRegister?.LstAttendanceStudents;
  if (!Array.isArray(src) || src.length === 0) {
    alert("‚ùå Roster not found");
    return;
  }
 
  const roster = src.map((s, i) => ({
    sr: i + 1,
    regNo: s.DisplayReg_No,
    name: s.StudentName
  }));

  // Extract section from page
  let section = "NA";
  
  // Method 1: Try to get from section dropdown/display
  const sectionElement = document.querySelector('[id*="Section"]') || 
                         document.querySelector('[name*="Section"]');
  if (sectionElement) {
    section = sectionElement.value || sectionElement.textContent.trim();
  }
  
  // Method 2: Try window.section variable
  if (window.section) {
    section = window.section;
  }
  
  // Method 3: Ask user for section
  if (section === "NA" || !section) {
    section = prompt("Enter section (e.g., A, B, C):", "A") || "NA";
  }
 
  const payload = {
    type: "roster",
    courseId: window.courseId,
    section: section,
    facultyId: window.FacultyId,
    extractedAt: new Date().toISOString(),
    totalStudents: roster.length,
    roster
  };
 
  const SECRET = encodeURIComponent("k9F@3xQp7L_92aZ!rT");
  const ENDPOINT = "https://script.google.com/macros/s/AKfycbwYc1nyNY5pyiSrDO3jpySSaTHKIfSZnZlp0c0dCernaKNGchBY9PbnttxoQ7rUn7GE/exec";
 
  console.log("üì§ Sending to Drive...");
  console.log("Section:", section);
 
  fetch(\`\${ENDPOINT}?secret=\${SECRET}\`, {
    method: 'POST',
    body: JSON.stringify(payload)
  })
  .then(r => r.json())
  .then(data => {
    console.log("üì• Server response:", data);
   
    if (data.ok) {
      console.log("‚úÖ File created:", data.filename);
      console.log("üîó View file:", data.fileUrl);
      console.log("üìä Students synced:", data.studentsCount);
      alert(\`‚úÖ Roster synced successfully!\n\nüìÅ \${data.filename}\nüë• \${data.studentsCount} students\nSection: \${section}\n\nüîó Click to open:\n\${data.fileUrl}\`);
    } else {
      console.error("‚ùå Server error:", data.error);
      alert(\`‚ùå Sync failed: \${data.error}\`);
    }
  })
  .catch(err => {
    console.error("‚ùå Network error:", err);
    alert(\`‚ùå Network error: \${err.message}\`);
  });
})();`;

      document.getElementById('bookmarkletCode').textContent = code;
      document.getElementById('bookmarkletOutput').style.display = 'block';
    }

    // Copy bookmarklet
    function copyBookmarklet() {
      const code = document.getElementById('bookmarkletCode').textContent;
      navigator.clipboard.writeText(code).then(() => {
        alert('‚úÖ Copied to clipboard!');
      });
    }

    // Load rosters from API
    async function loadRosters() {
      document.getElementById('rostersList').innerHTML = '<div class="alert info">‚è≥ Loading rosters...</div>';
      
      try {
        const response = await fetch(`${API_URL}?action=listRosters&secret=${SECRET}`);
        const data = await response.json();
        
        if (data.ok && data.rosters) {
          const rosters = data.rosters;
          
          if (rosters.length === 0) {
            document.getElementById('rostersList').innerHTML = '<div class="alert info">No rosters found. Use the scraper to sync rosters from CUOnline.</div>';
            return;
          }
          
          let html = `
            <table>
              <thead>
                <tr>
                  <th>Filename</th>
                  <th>Course</th>
                  <th>Section</th>
                  <th>Students</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          rosters.forEach(r => {
            html += `
              <tr>
                <td>${r.filename}</td>
                <td>${r.courseId}</td>
                <td><span class="badge blue">${r.section}</span></td>
                <td>${r.totalStudents}</td>
                <td>${r.date}</td>
                <td><a href="${r.url}" target="_blank"><button class="btn secondary" style="padding: 6px 12px; font-size: 12px;">View</button></a></td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          document.getElementById('rostersList').innerHTML = html;
          
          // Update stats
          document.getElementById('totalRosters').textContent = rosters.length;
          const totalStudents = rosters.reduce((sum, r) => sum + (r.totalStudents || 0), 0);
          document.getElementById('totalStudents').textContent = totalStudents;
          const uniqueSections = new Set(rosters.map(r => `${r.courseId}_${r.section}`));
          document.getElementById('totalSections').textContent = uniqueSections.size;
        } else {
          document.getElementById('rostersList').innerHTML = `<div class="alert error">‚ùå ${data.error || 'Failed to load rosters'}</div>`;
        }
      } catch (error) {
        document.getElementById('rostersList').innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Assign CR
    async function assignCR() {
      const email = document.getElementById('crEmail').value.trim();
      const courseId = document.getElementById('crCourseId').value.trim();
      const section = document.getElementById('crSection').value;

      if (!email || !courseId) {
        document.getElementById('crStatus').innerHTML = '<div class="alert error">‚ö†Ô∏è Please fill all fields</div>';
        return;
      }

      document.getElementById('crStatus').innerHTML = '<div class="alert info">‚è≥ Assigning CR...</div>';

      try {
        const url = `${API_URL}?action=assignCR&secret=${SECRET}&email=${encodeURIComponent(email)}&courseId=${courseId}&section=${section}`;
        const response = await fetch(url);
        const data = await response.json();

        if (data.ok) {
          document.getElementById('crStatus').innerHTML = `<div class="alert success">‚úÖ CR ${email} assigned to Course ${courseId}, Section ${section}</div>`;
          
          // Add to table
          const tbody = document.getElementById('crList');
          if (tbody.querySelector('td[colspan]')) {
            tbody.innerHTML = '';
          }
          tbody.innerHTML += `
            <tr>
              <td>${email}</td>
              <td><span class="badge blue">Section ${section}</span></td>
              <td>${courseId}</td>
              <td><span class="badge green">Active</span></td>
            </tr>
          `;
        } else {
          document.getElementById('crStatus').innerHTML = `<div class="alert error">‚ùå ${data.error}</div>`;
        }
      } catch (error) {
        document.getElementById('crStatus').innerHTML = `<div class="alert error">‚ùå Error: ${error.message}</div>`;
      }
    }

    // Unlock attendance
    function unlockAttendance() {
      const courseId = document.getElementById('unlockCourseId').value;
      const section = document.getElementById('unlockSection').value;
      const date = document.getElementById('unlockDate').value;

      if (!courseId || !date) {
        document.getElementById('unlockStatus').innerHTML = '<div class="alert error">‚ö†Ô∏è Please fill all fields</div>';
        return;
      }

      document.getElementById('unlockStatus').innerHTML = '<div class="alert info">‚è≥ Unlocking...</div>';
      
      setTimeout(() => {
        document.getElementById('unlockStatus').innerHTML = `<div class="alert success">‚úÖ Attendance unlocked for Course ${courseId}, Section ${section}, Date ${date}</div>`;
      }, 1000);
    }

    // Add student
    function addStudent() {
      const courseId = document.getElementById('addCourseId').value;
      const section = document.getElementById('addSection').value;
      const regNo = document.getElementById('addRegNo').value;
      const name = document.getElementById('addName').value;

      if (!courseId || !regNo || !name) {
        document.getElementById('addStatus').innerHTML = '<div class="alert error">‚ö†Ô∏è Please fill all fields</div>';
        return;
      }

      document.getElementById('addStatus').innerHTML = '<div class="alert info">‚è≥ Adding student...</div>';
      
      setTimeout(() => {
        document.getElementById('addStatus').innerHTML = `<div class="alert success">‚úÖ Student ${name} (${regNo}) added to Course ${courseId}, Section ${section}</div>`;
      }, 1000);
    }

    // Load stats on page load
    window.addEventListener('DOMContentLoaded', () => {
      loadRosters();
    });
  </script>
</body>
</html>