<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#363763" />
  <meta name="description" content="CR Attendance Management System with Biometric Auth & Offline Support" />
  <title>CR Attendance ‚Äì COMSATS Enhanced</title>

  <!-- PWA Manifest -->
  <link rel="manifest" href="./manifest.json">

  <!-- Chart.js for Analytics -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

  <style>
    :root {
      --cui-primary: #363763;
      --cui-primary-2: #1e1f4a;
      --cui-danger: #BD3850;
      --cui-success: #22c25f;
      --cui-bg: #f4f5f7;
      --cui-card: #ffffff;
      --cui-text: #1b1e28;
      --cui-muted: #6b7280;
      --cui-line: #e5e7eb;
      --cui-shadow: 0 10px 24px rgba(0, 0, 0, .10);
      --radius: 14px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: var(--cui-bg);
      color: var(--cui-text);
    }

    .wrap {
      min-height: 100vh;
      display: grid;
      place-items: center;
      padding: 18px;
    }

    .phone {
      width: min(430px, 100%);
      border: 1px solid #d7dbe2;
      border-radius: 26px;
      overflow: hidden;
      background: var(--cui-card);
      box-shadow: var(--cui-shadow);
      display: flex;
      flex-direction: column;
    }

    .topbar {
      background: linear-gradient(180deg, var(--cui-primary-2), var(--cui-primary));
      color: #fff;
      padding: 14px 14px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, .18);
      flex-shrink: 0;
    }

    .topbar .row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand .h {
      font-weight: 700;
      font-size: 16px;
      letter-spacing: .2px;
    }

    .brand .s {
      opacity: .85;
      font-size: 12px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid rgba(255, 255, 255, .30);
      background: rgba(255, 255, 255, .10);
      white-space: nowrap;
    }

    .mini-btn {
      border: 1px solid rgba(255, 255, 255, .30);
      background: rgba(255, 255, 255, .12);
      color: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
      cursor: pointer;
      transition: all .2s;
    }

    .mini-btn:hover {
      background: rgba(255, 255, 255, .18);
    }

    .content {
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      overflow-y: auto;
      flex: 1;
      max-height: calc(100% - 200px);
    }

    .card {
      border: 1px solid var(--cui-line);
      border-radius: var(--radius);
      padding: 12px;
      background: #fff;
    }

    .summary {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .summary .h {
      font-weight: 800;
    }

    .summary .pill2 {
      border: 1px solid var(--cui-line);
      background: #f8fafc;
      color: var(--cui-muted);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      white-space: nowrap;
    }

    .meta {
      display: grid;
      grid-template-columns: 1fr;
      gap: 6px;
      font-size: 13px;
    }

    .kv {
      display: flex;
      gap: 10px;
      align-items: baseline;
    }

    .k {
      width: 70px;
      color: var(--cui-muted);
    }

    .v {
      font-weight: 700;
    }

    input[type="date"],
    input[type="time"],
    input[type="email"],
    select {
      border: 1px solid var(--cui-line);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 13px;
      outline: none;
      width: 100%;
    }

    input[type="date"]:focus,
    input[type="time"]:focus,
    input[type="email"]:focus,
    select:focus {
      border-color: var(--cui-primary);
      box-shadow: 0 0 0 3px rgba(54, 55, 99, .12);
    }

    .checkrow {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      font-size: 13px;
      margin-bottom: 10px;
    }

    .checkrow input {
      width: 18px;
      height: 18px;
      margin-top: 2px;
    }

    textarea {
      width: 100%;
      border: 1px solid var(--cui-line);
      border-radius: 10px;
      padding: 10px;
      font-family: inherit;
      font-size: 13px;
      min-height: 76px;
      outline: none;
    }

    textarea:focus {
      border-color: var(--cui-primary);
      box-shadow: 0 0 0 3px rgba(54, 55, 99, .12);
    }

    .count {
      font-size: 12px;
      color: var(--cui-muted);
      margin-top: 6px;
    }

    .search {
      width: 100%;
      border: 1px solid var(--cui-line);
      border-radius: 10px;
      padding: 10px;
      font-size: 13px;
      outline: none;
    }

    .search:focus {
      border-color: var(--cui-primary);
      box-shadow: 0 0 0 3px rgba(54, 55, 99, .12);
    }

    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .btn {
      border: 1px solid var(--cui-line);
      background: #f8fafc;
      color: var(--cui-text);
      border-radius: 10px;
      padding: 9px 10px;
      font-size: 13px;
      cursor: pointer;
      transition: all .2s;
    }

    .btn:hover {
      background: #eef2f7;
    }

    .btn.primary {
      border-color: rgba(54, 55, 99, .25);
      background: rgba(54, 55, 99, .10);
      color: var(--cui-primary);
    }

    .btn.danger {
      border-color: rgba(189, 56, 80, .25);
      background: rgba(189, 56, 80, .08);
      color: var(--cui-danger);
    }

    .btn.success {
      border-color: rgba(34, 194, 95, .25);
      background: rgba(34, 194, 95, .08);
      color: var(--cui-success);
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed;
    }

    .list {
      margin-top: 10px;
      border-top: 1px solid var(--cui-line);
    }

    .stu {
      display: grid;
      grid-template-columns: 34px 1fr 90px;
      gap: 10px;
      padding: 10px 4px;
      border-bottom: 1px solid var(--cui-line);
      align-items: center;
    }

    .sr {
      text-align: center;
      color: var(--cui-muted);
      font-size: 12px;
    }

    .who {
      min-width: 0;
    }

    .reg {
      color: var(--cui-muted);
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .name {
      font-weight: 700;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .pa {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .radio {
      width: 38px;
      height: 32px;
      border-radius: 10px;
      border: 1px solid var(--cui-line);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      cursor: pointer;
      user-select: none;
      background: #fff;
      transition: all .2s;
    }

    .radio:hover {
      border-color: var(--cui-primary);
    }

    .radio.onP {
      border-color: rgba(34, 194, 107, .40);
      background: rgba(34, 194, 107, .15);
      color: var(--cui-success);
    }

    .radio.onA {
      border-color: rgba(189, 56, 80, .40);
      background: rgba(189, 56, 80, .15);
      color: var(--cui-danger);
    }

    .footer {
      border-top: 1px solid var(--cui-line);
      padding: 12px;
      background: #fff;
      flex-shrink: 0;
      overflow-y: auto;
      max-height: 150px;
    }

    .submitIconBtn {
      display: flex;
      align-items: center;
      gap: 10px;
      width: 100%;
      justify-content: center;
      border: 1px solid rgba(54, 55, 99, .25);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
      background: linear-gradient(180deg, var(--cui-primary-2), var(--cui-primary));
      color: #fff;
      font-weight: 800;
      letter-spacing: .2px;
      transition: all .2s;
    }

    .submitIconBtn:hover {
      filter: brightness(1.05);
    }

    .submitIconBtn:active {
      transform: translateY(1px);
    }

    .submitIconBtn[disabled] {
      opacity: .55;
      cursor: not-allowed;
      filter: grayscale(.3);
    }

    .status {
      margin-top: 10px;
      font-size: 13px;
      color: var(--cui-muted);
      line-height: 1.3;
    }

    .backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 999;
      overflow-y: auto;
    }

    .modal {
      width: min(430px, 100%);
      background: #fff;
      border-radius: 16px;
      border: 1px solid var(--cui-line);
      box-shadow: var(--cui-shadow);
      padding: 14px;
      margin: auto;
    }

    .modal h3 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .modal p {
      margin: 0 0 10px;
      color: var(--cui-muted);
      font-size: 13px;
    }

    .modal ul {
      margin: 0 0 12px;
      padding-left: 18px;
      font-size: 13px;
    }

    .modal li {
      margin: 4px 0;
    }

    .actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
    }

    .badge.online {
      background: rgba(34, 194, 107, .15);
      color: var(--cui-success);
      border: 1px solid rgba(34, 194, 107, .3);
    }

    .badge.offline {
      background: rgba(255, 159, 64, .15);
      color: #ff9f40;
      border: 1px solid rgba(255, 159, 64, .3);
    }

    .badge.locked {
      background: rgba(189, 56, 80, .15);
      color: var(--cui-danger);
      border: 1px solid rgba(189, 56, 80, .3);
    }

    .badge.approved {
      background: rgba(34, 194, 107, .15);
      color: var(--cui-success);
      border: 1px solid rgba(34, 194, 107, .3);
    }

    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .tab-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--cui-line);
      background: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      transition: all .2s;
    }

    .tab-btn.active {
      background: var(--cui-primary);
      color: #fff;
      border-color: var(--cui-primary);
    }

    .qr-container {
      text-align: center;
      margin: 10px 0;
    }

    .qr-container canvas,
    .qr-container img {
      max-width: 100%;
      border: 1px solid var(--cui-line);
      border-radius: 10px;
    }

    @media (max-width: 360px) {
      .stu {
        grid-template-columns: 30px 1fr 86px;
      }

      .radio {
        width: 36px;
      }
    }

    /* Animation */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    .fade-in {
      animation: fadeIn .3s ease-in;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="phone" role="application" aria-label="Enhanced CR Attendance PWA">
      <div class="topbar">
        <div class="row">
          <div class="brand">
            <div class="h" id="brandTitle">üì± CUOnline Attendance</div>
            <div class="s" id="crInfo">Loading...</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;">
            <div id="netPill" class="pill badge online">üü¢ Online</div>
            <button id="userBtn" class="mini-btn" title="User profile">üë§</button>
          </div>
        </div>
      </div>

      <div class="content" id="mainContent">
        <!-- ATTENDANCE FORM SECTION -->
        <div class="card">
          <div class="summary">
            <div class="h">Attendance Entry</div>
            <div class="pill2" id="statusBadge">‚úèÔ∏è Edit Mode</div>
          </div>
          <div class="meta" style="margin-top:10px;">
            <div class="kv">
              <div class="k">Course</div>
              <div class="v" id="course">Loading...</div>
            </div>
            <div class="kv">
              <div class="k">Section</div>
              <div class="v" id="sectionDisplay">-</div>
            </div>
            <div class="kv">
              <div class="k">Date</div>
              <div class="v"><input type="date" id="dateInput" /></div>
            </div>
            <div class="kv">
              <div class="k">Time</div>
              <div class="v"><input type="time" id="startTime" value="09:00" /> ‚Äì <input type="time" id="endTime"
                  value="10:20" /></div>
            </div>
            <div class="kv">
              <div class="k">Type</div>
              <div class="v"><select id="typeSelect">
                  <option value="1">Class</option>
                  <option value="2">Lab</option>
                  <option value="4">Exam</option>
                </select></div>
            </div>
          </div>
        </div>

        <!-- LECTURE NOTES -->
        <div class="card">
          <div class="checkrow">
            <input type="checkbox" id="isOnline" />
            <label for="isOnline"><b>Online Class</b></label>
          </div>
          <div style="color: var(--cui-danger); font-weight: 700; margin-bottom: 6px;">Lecture Notes / Content</div>
          <textarea id="notes" placeholder="Type lecture notes here" maxlength="2999"></textarea>
          <div class="count"><span id="count">0</span>/2999</div>
        </div>

        <!-- STUDENTS ATTENDANCE -->
        <div class="card">
          <div class="summary">
            <div class="h">Students</div>
            <div class="pill2" id="summary">Present: 0 ‚Ä¢ Absent: 0</div>
          </div>
          <input id="search" class="search" type="search" placeholder="Search by name or reg no" />
          <div class="controls">
            <button class="btn primary" id="allP">Mark All Present</button>
            <button class="btn danger" id="allA">Mark All Absent</button>
            <button class="btn" id="reset">Reset</button>
            <button class="btn" id="syncRosterBtn">üîÑ Sync Roster</button>
          </div>
          <div class="list" id="list"></div>
        </div>

        <!-- ANALYTICS TAB (Collapsible) -->
        <div class="card" id="analyticsCard" style="display:none;">
          <div class="h" style="margin-bottom:10px;">üìä Analytics</div>
          <canvas id="attendanceChart" style="max-height:200px;"></canvas>
        </div>
      </div>

      <div class="footer">
        <div class="controls" style="margin-bottom:10px; font-size:12px;">
          <button class="btn" id="emailAttendanceBtn" title="Email attendance to faculty">üìß Email Attendance</button>
          <button class="btn" id="analyticsBtn" title="View analytics">üìä Analytics</button>
        </div>

        <button id="submit" class="submitIconBtn">
          <span>‚úì</span>
          <div>Submit & Lock</div>
        </button>

        <div class="status" id="status">Ready to mark attendance. Click students to toggle Present/Absent.</div>
      </div>
    </div>
  </div>

  <!-- CR LOGIN MODAL -->
  <div class="backdrop" id="loginBackdrop" style="display:flex;">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>üë§ CR Login</h3>
      <p>Enter your COMSATS email to access your section's attendance</p>
      <div style="margin-bottom:12px;">
        <label style="display:block; margin-bottom:6px; font-weight:700; font-size:13px;">CR Email</label>
        <input type="email" id="loginEmail" placeholder="cr@comsats.edu.pk"
          style="width:100%; border:1px solid var(--cui-line); border-radius:10px; padding:10px; font-size:13px;" />
      </div>
      <div class="actions">
        <button class="btn primary" id="loginBtn" style="width:100%;">‚úì Login</button>
      </div>
      <div id="loginStatus" style="margin-top:10px; font-size:13px; color:var(--cui-muted);"></div>
    </div>
  </div>

  <!-- SUBMIT CONFIRMATION MODAL -->
  <div class="backdrop" id="submitBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Confirm Submit & Lock</h3>
      <p>Once submitted:</p>
      <ul>
        <li>Attendance will be <b>LOCKED</b></li>
        <li>Sent to faculty for approval</li>
        <li>If offline, will sync when online</li>
      </ul>
      <div class="actions">
        <button class="btn" id="cancelSubmit">Cancel</button>
        <button class="btn primary" id="confirmSubmit">‚úì Confirm Submit</button>
      </div>
    </div>
  </div>

  <!-- EMAIL SUBMISSION MODAL -->
  <div class="backdrop" id="emailBackdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>üìß Email Attendance to Faculty</h3>
      <div style="margin:10px 0;">
        <label style="display:block; margin-bottom:8px;"><b>Faculty Email:</b></label>
        <input type="email" id="facultyEmail" placeholder="faculty@comsats.edu.pk"
          style="width:100%; border:1px solid var(--cui-line); border-radius:8px; padding:8px; font-size:13px;">
        <div style="margin-top:8px; font-size:12px; color:var(--cui-muted);">The attendance will be stored in cloud and
          emailed to faculty for approval.</div>
      </div>
      <div class="controls" style="margin-top:10px;">
        <button class="btn" id="cancelEmail">Cancel</button>
        <button class="btn primary" id="sendEmail">‚úì Send Email</button>
      </div>
      <div class="status" id="emailStatus" style="margin-top:8px;"></div>
    </div>
  </div>

  <script>
    // Check browser support
    const supportsPWA = () => ('serviceWorker' in navigator);
    const supportsIndexedDB = () => (!!window.indexedDB);

    console.log('üì± PWA Support:', { serviceWorker: supportsPWA(), idb: supportsIndexedDB() });

    // =====================
    // GOOGLE APPS SCRIPT CONFIG
    // =====================
    const APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbyhPSc9TrLpIZl4DOxSzmAFQo1CBkrk6typ4d5ItCeSXeKeNLEnA-Y6hXLAfzRCZlQH/exec";
    const ROSTER_URL = "https://script.google.com/macros/s/AKfycbyhPSc9TrLpIZl4DOxSzmAFQo1CBkrk6typ4d5ItCeSXeKeNLEnA-Y6hXLAfzRCZlQH/exec";
    const ROSTER_SECRET = "k9F@3xQp7L_92aZ!rT";

    // =====================
    // INDEXEDDB HELPER
    // =====================
    class AttendanceDB {
      constructor() {
        this.dbName = 'CR_Attendance_v1';
        this.db = null;
      }

      async init() {
        return new Promise((resolve, reject) => {
          const req = indexedDB.open(this.dbName, 2);
          req.onerror = () => reject(req.error);
          req.onsuccess = () => { this.db = req.result; resolve(); };
          req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains('attendance')) {
              db.createObjectStore('attendance', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('drafts')) {
              db.createObjectStore('drafts', { keyPath: 'id' });
            }
            if (!db.objectStoreNames.contains('roster')) {
              db.createObjectStore('roster', { keyPath: 'id' });
            }
          };
        });
      }

      async saveDraft(data) {
        const tx = this.db.transaction('drafts', 'readwrite');
        tx.objectStore('drafts').put({ id: 'current', data, savedAt: Date.now() });
        return new Promise((resolve, reject) => {
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      }

      async getDraft() {
        const tx = this.db.transaction('drafts', 'readonly');
        return new Promise((resolve, reject) => {
          const req = tx.objectStore('drafts').get('current');
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }

      async saveSubmission(submission) {
        const tx = this.db.transaction('attendance', 'readwrite');
        tx.objectStore('attendance').put(submission);
        return new Promise((resolve, reject) => {
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      }

      async getSubmissions() {
        const tx = this.db.transaction('attendance', 'readonly');
        return new Promise((resolve, reject) => {
          const req = tx.objectStore('attendance').getAll();
          req.onsuccess = () => resolve(req.result || []);
          req.onerror = () => reject(req.error);
        });
      }

      async saveRoster(payload) {
        const tx = this.db.transaction('roster', 'readwrite');
        tx.objectStore('roster').put({ id: 'current', data: payload, savedAt: Date.now() });
        return new Promise((resolve, reject) => {
          tx.oncomplete = resolve;
          tx.onerror = () => reject(tx.error);
        });
      }

      async getRoster() {
        const tx = this.db.transaction('roster', 'readonly');
        return new Promise((resolve, reject) => {
          const req = tx.objectStore('roster').get('current');
          req.onsuccess = () => resolve(req.result);
          req.onerror = () => reject(req.error);
        });
      }
    }

    // =====================
    // APP STATE
    // =====================
    const db = new AttendanceDB();
    let isOnline = navigator.onLine;
    let locked = false;
    let currentUser = { email: '', role: 'CR', courseId: '', section: '' };

    const marks = new Map();
    let students = [];
    let rosterMeta = {};

    // =====================
    // DOM REFS
    // =====================
    const netPill = document.getElementById('netPill');
    const userBtn = document.getElementById('userBtn');
    const isOnlineChk = document.getElementById('isOnline');
    const notes = document.getElementById('notes');
    const count = document.getElementById('count');
    const search = document.getElementById('search');
    const allP = document.getElementById('allP');
    const allA = document.getElementById('allA');
    const reset = document.getElementById('reset');
    const list = document.getElementById('list');
    const summary = document.getElementById('summary');
    const submitBtn = document.getElementById('submit');
    const status = document.getElementById('status');
    const statusBadge = document.getElementById('statusBadge');
    const analyticsBtn = document.getElementById('analyticsBtn');
    const analyticsCard = document.getElementById('analyticsCard');
    const syncRosterBtn = document.getElementById('syncRosterBtn');

    const loginBackdrop = document.getElementById('loginBackdrop');
    const loginEmail = document.getElementById('loginEmail');
    const loginBtn = document.getElementById('loginBtn');
    const loginStatus = document.getElementById('loginStatus');

    const submitBackdrop = document.getElementById('submitBackdrop');
    const confirmSubmit = document.getElementById('confirmSubmit');
    const cancelSubmit = document.getElementById('cancelSubmit');

    const emailBackdrop = document.getElementById('emailBackdrop');
    const facultyEmail = document.getElementById('facultyEmail');
    const emailStatus = document.getElementById('emailStatus');
    const sendEmail = document.getElementById('sendEmail');
    const cancelEmail = document.getElementById('cancelEmail');

    // =====================
    // CR AUTHENTICATION
    // =====================
    async function authenticateCR(email) {
      // Use listCRs (confirmed working on live deployment) and filter by email
      const params = new URLSearchParams({
        action: 'listCRs',
        secret: ROSTER_SECRET
      });

      const url = `${ROSTER_URL}?${params.toString()}`;

      // Google Apps Script redirects can return HTML in cross-origin contexts
      // We need to handle this explicitly
      let text;
      try {
        const res = await fetch(url, { redirect: 'follow' });
        text = await res.text();
      } catch (e) {
        throw new Error('Network error: ' + e.message);
      }

      // If the response is HTML (GAS redirect page), extract the actual data URL
      let data;
      if (text.trim().startsWith('{')) {
        // Direct JSON response
        data = JSON.parse(text);
      } else if (text.includes('<!DOCTYPE') || text.includes('<html')) {
        // GAS returned an HTML redirect page ‚Äî try to extract the URL
        console.warn('GAS returned HTML instead of JSON. Attempting workaround...');
        console.log('Response preview:', text.substring(0, 200));
        throw new Error('Google Apps Script returned HTML. Open your GAS project ‚Üí Deploy ‚Üí Manage deployments ‚Üí Edit ‚Üí Set "Who has access" to "Anyone" ‚Üí Save.');
      } else {
        throw new Error('Unexpected response format');
      }

      if (!data.ok) throw new Error(data.error || 'Failed to fetch CR list');

      const crs = data.crs || [];
      const match = crs.find(cr => cr.email.toLowerCase() === email.toLowerCase());

      if (!match) throw new Error('No CR assignment found for this email. Ask your admin to assign you first.');

      return match;
    }


    function saveCRToStorage(assignment) {
      currentUser.email = assignment.email;
      currentUser.courseId = assignment.courseId;
      currentUser.section = assignment.section;
      localStorage.setItem('cr_email', assignment.email);
      localStorage.setItem('cr_assignment', JSON.stringify(assignment));
    }

    function loadCRFromStorage() {
      const email = localStorage.getItem('cr_email');
      const assignmentStr = localStorage.getItem('cr_assignment');

      if (email && assignmentStr) {
        try {
          const assignment = JSON.parse(assignmentStr);
          currentUser.email = assignment.email;
          currentUser.courseId = assignment.courseId;
          currentUser.section = assignment.section;
          return true;
        } catch (e) {
          return false;
        }
      }
      return false;
    }

    function logoutCR() {
      localStorage.removeItem('cr_email');
      localStorage.removeItem('cr_assignment');
      location.reload();
    }

    // =====================
    // HELPER: Set today's date
    // =====================
    function setTodayDate() {
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth() + 1).padStart(2, '0');
      const dd = String(today.getDate()).padStart(2, '0');
      document.getElementById('dateInput').value = `${yyyy}-${mm}-${dd}`;
    }

    // =====================
    // FUNCTIONS
    // =====================
    function setNet() {
      netPill.textContent = isOnline ? 'üü¢ Online' : 'üü° Offline';
      netPill.className = 'pill badge ' + (isOnline ? 'online' : 'offline');
      status.textContent = isOnline ? '‚úÖ Online: ready to submit.' : 'üü° Offline: changes saved locally, will sync when online.';
    }

    function updateSummary() {
      let p = 0, a = 0;
      for (const v of marks.values()) (v === 'P' ? p++ : a++);
      summary.textContent = `Present: ${p} ‚Ä¢ Absent: ${a}`;
    }

    function render() {
      const q = (search.value || '').trim().toLowerCase();
      list.innerHTML = '';
      const filtered = students.filter(s =>
        !q ||
        (s.displayReg || s.regNo).toLowerCase().includes(q) ||
        s.name.toLowerCase().includes(q)
      );

      filtered.forEach((s, idx) => {
        const choice = marks.get(s.regNo) || 'P';
        const row = document.createElement('div');
        row.className = 'stu';
        row.innerHTML = `
          <div class="sr">${idx + 1}</div>
          <div class="who">
            <div class="reg">${s.displayReg || s.regNo}</div>
            <div class="name">${s.name}</div>
          </div>
          <div class="pa">
            <div class="radio ${choice === 'P' ? 'onP' : ''}" data-action="P" data-reg="${s.regNo}">P</div>
            <div class="radio ${choice === 'A' ? 'onA' : ''}" data-action="A" data-reg="${s.regNo}">A</div>
          </div>
        `;
        list.appendChild(row);
      });

      updateSummary();

      document.querySelectorAll('.radio').forEach(btn => {
        btn.addEventListener('click', async () => {
          if (locked) return;
          const reg = btn.dataset.reg;
          const action = btn.dataset.action;
          marks.set(reg, action);
          render();
          await saveDraftLocal();
        });
      });
    }

    async function saveDraftLocal() {
      try {
        const draft = {
          meta: {
            date: document.getElementById('dateInput').value,
            startTime: document.getElementById('startTime').value,
            endTime: document.getElementById('endTime').value,
            classType: document.getElementById('typeSelect').value,
            isOnline: isOnlineChk.checked,
            lectureNotes: notes.value
          },
          marks: Object.fromEntries(marks.entries()),
          locked
        };
        await db.saveDraft(draft);
      } catch (e) {
        console.warn('Draft save failed:', e);
      }
    }

    async function restoreDraftLocal() {
      try {
        const draft = await db.getDraft();
        if (!draft || !draft.data) return;
        const d = draft.data;

        document.getElementById('dateInput').value = d.meta.date || document.getElementById('dateInput').value;
        document.getElementById('startTime').value = d.meta.startTime || '09:00';
        document.getElementById('endTime').value = d.meta.endTime || '10:20';
        document.getElementById('typeSelect').value = String(d.meta.classType || '1');
        isOnlineChk.checked = !!d.meta.isOnline;
        notes.value = d.meta.lectureNotes || '';
        count.textContent = String((d.meta.lectureNotes || '').length);

        if (d.marks) {
          for (const [k, v] of Object.entries(d.marks)) marks.set(k, v);
        }

        locked = !!d.locked;
      } catch (e) {
        console.warn('Draft restore failed:', e);
      }
    }

    function buildAttendanceJson() {
      return {
        course: rosterMeta.courseName || document.getElementById('course').textContent,
        courseValue: rosterMeta.courseId || currentUser.courseId,
        section: rosterMeta.section || currentUser.section,
        date: document.getElementById('dateInput').value,
        startTime: document.getElementById('startTime').value,
        endTime: document.getElementById('endTime').value,
        classType: document.getElementById('typeSelect').value,
        isOnline: isOnlineChk.checked,
        lectureNotes: notes.value || '',
        crEmail: currentUser.email,
        submittedAt: new Date().toISOString(),
        students: students.map((s, i) => ({
          sr: i + 1,
          reg: s.regNo,
          name: s.name,
          present: (marks.get(s.regNo) || 'P') === 'P'
        }))
      };
    }

    // =====================
    // ROSTER
    // =====================

    /**
     * Fetches the latest roster from the server for this CR's courseId + section.
     * Sends action=getLatestRoster so the Apps Script can find the newest
     * Drive file matching: roster_course_{courseId}_section_{section}_{YYYY-MM-DD}
     */
    async function fetchRosterFromServer() {
      if (!ROSTER_URL) {
        throw new Error('ROSTER_URL not configured');
      }

      const params = new URLSearchParams({
        action: 'getLatestRoster',
        secret: ROSTER_SECRET,
        crEmail: currentUser.email,
        courseId: currentUser.courseId,
        section: currentUser.section
      });

      const res = await fetch(`${ROSTER_URL}?${params.toString()}`);
      if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      }
      const data = await res.json();
      if (data.ok === false && data.error) {
        throw new Error(data.error);
      }
      return data;
    }

    function applyRoster(payload) {
      const roster = payload.roster || [];

      rosterMeta = {
        courseId: payload.courseId || currentUser.courseId,
        courseName: payload.courseName || `Course ${payload.courseId || currentUser.courseId}`,
        section: payload.section || currentUser.section,
        fileName: payload.fileName || null,
        fileDate: payload.fileDate || null
      };

      document.getElementById('course').textContent = rosterMeta.courseName;
      document.getElementById('sectionDisplay').textContent = rosterMeta.section;
      document.getElementById('crInfo').textContent = `${currentUser.email} ‚Ä¢ Section ${rosterMeta.section}`;

      students = roster.map((item) => ({
        regNo: item.regNo,
        displayReg: item.regNo,
        name: item.name || 'Unknown'
      }));

      marks.clear();
      students.forEach(s => marks.set(s.regNo, 'P'));

      render();
      const fileInfo = rosterMeta.fileDate ? ` ‚Ä¢ ${rosterMeta.fileDate}` : '';
      status.textContent = `üìÅ Roster loaded (${students.length} students)${fileInfo}.`;
    }

    async function initRoster() {
      try {
        const saved = await db.getRoster();
        if (saved && saved.data) {
          applyRoster(saved.data);
          const cachedFile = saved.data.fileDate ? ` [${saved.data.fileDate}]` : '';
          status.textContent = `üìÅ Loaded roster from offline cache (${students.length} students)${cachedFile}.`;
        }

        if (isOnline) {
          status.textContent = '‚è≥ Syncing latest roster from server...';
          const fresh = await fetchRosterFromServer();
          await db.saveRoster(fresh);
          applyRoster(fresh);
          const fileInfo = fresh.fileDate ? ` [${fresh.fileDate}]` : '';
          status.textContent = `‚úÖ Roster synced from server (${students.length} students)${fileInfo}.`;
        } else if (!saved) {
          status.textContent = 'üü° Offline and no roster cached yet. Connect once to fetch roster.';
        }
      } catch (e) {
        console.error('Roster init failed:', e);
        if (!students.length) {
          status.textContent = '‚ùå Failed to load roster: ' + e.message;
        }
      }
    }

    async function syncRoster() {
      if (!isOnline) {
        status.textContent = 'üü° Cannot sync roster while offline.';
        return;
      }

      status.textContent = '‚è≥ Syncing latest roster...';
      try {
        const fresh = await fetchRosterFromServer();
        await db.saveRoster(fresh);
        applyRoster(fresh);
        const fileInfo = rosterMeta.fileDate ? ` ‚Ä¢ ${rosterMeta.fileDate}` : '';
        status.textContent = `‚úÖ Roster updated (${students.length} students)${fileInfo}.`;
      } catch (e) {
        console.error('Sync failed:', e);
        status.textContent = '‚ùå Roster sync failed: ' + e.message;
      }
    }

    // =====================
    // LOGIN EVENTS
    // =====================
    loginBtn.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      if (!email) {
        loginStatus.textContent = '‚ö†Ô∏è Please enter your email';
        loginStatus.style.color = 'var(--cui-danger)';
        return;
      }

      loginStatus.textContent = '‚è≥ Authenticating...';
      loginStatus.style.color = 'var(--cui-muted)';
      loginBtn.disabled = true;

      try {
        const assignment = await authenticateCR(email);
        saveCRToStorage(assignment);

        loginStatus.textContent = '‚úÖ Login successful!';
        loginStatus.style.color = 'var(--cui-success)';

        loginBackdrop.style.display = 'none';

        await initRoster();
        await restoreDraftLocal();
        render();
      } catch (e) {
        loginStatus.textContent = '‚ùå ' + e.message;
        loginStatus.style.color = 'var(--cui-danger)';
        loginBtn.disabled = false;
      }
    });

    loginEmail.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loginBtn.click();
    });

    // =====================
    // EVENTS
    // =====================
    notes.addEventListener('input', async () => {
      count.textContent = String(notes.value.length);
      if (!locked) await saveDraftLocal();
    });

    search.addEventListener('input', render);

    ['change', 'input'].forEach(ev => {
      ['dateInput', 'startTime', 'endTime', 'typeSelect'].forEach(id => {
        document.getElementById(id).addEventListener(ev, async () => !locked && await saveDraftLocal());
      });
      isOnlineChk.addEventListener(ev, async () => !locked && await saveDraftLocal());
    });

    document.getElementById('emailAttendanceBtn').addEventListener('click', () => {
      facultyEmail.value = '';
      emailStatus.textContent = '';
      emailBackdrop.style.display = 'flex';
    });

    cancelEmail.addEventListener('click', () => {
      emailBackdrop.style.display = 'none';
    });

    sendEmail.addEventListener('click', async () => {
      const faculty = facultyEmail.value.trim();
      if (!faculty) {
        emailStatus.textContent = '‚ö†Ô∏è Please enter faculty email';
        return;
      }

      if (!APPSCRIPT_URL || APPSCRIPT_URL.includes('YOUR_DEPLOYMENT')) {
        emailStatus.textContent = '‚ö†Ô∏è Apps Script URL not configured. Check setup.';
        return;
      }

      const payload = buildAttendanceJson();
      payload.facultyEmail = faculty;

      emailStatus.textContent = '‚è≥ Submitting attendance...';
      sendEmail.disabled = true;

      try {
        const res = await fetch(`${APPSCRIPT_URL}?action=submitAttendance`, {
          method: 'POST',
          body: JSON.stringify(payload)
        });

        // GAS POST returns opaque or JSON ‚Äî treat any completion as success
        let result = { success: true };
        try {
          const text = await res.text();
          if (text.trim().startsWith('{')) result = JSON.parse(text);
        } catch (_) { }

        if (result.success === false) throw new Error(result.error || 'Submission failed');

        emailStatus.textContent = '‚úÖ Submitted! Email sent to faculty.';

        locked = true;
        statusBadge.textContent = 'üîí Locked';
        await saveDraftLocal();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span>‚úì</span><div>Submitted (Locked)</div>';
        status.textContent = '‚úÖ Attendance submitted! Check your email for confirmation.';

        setTimeout(() => {
          emailBackdrop.style.display = 'none';
        }, 2000);
      } catch (error) {
        emailStatus.textContent = `‚ùå Error: ${error.message}. Check console (F12).`;
        console.error('Apps Script Error:', error);
        sendEmail.disabled = false;
      }
    });

    allP.addEventListener('click', async () => {
      if (locked) return;
      students.forEach(s => marks.set(s.regNo, 'P'));
      render();
      await saveDraftLocal();
    });

    allA.addEventListener('click', async () => {
      if (locked) return;
      students.forEach(s => marks.set(s.regNo, 'A'));
      render();
      await saveDraftLocal();
    });

    reset.addEventListener('click', async () => {
      if (locked) return;
      isOnlineChk.checked = false;
      notes.value = '';
      count.textContent = '0';
      search.value = '';
      students.forEach(s => marks.set(s.regNo, 'P'));
      render();
      await saveDraftLocal();
    });

    submitBtn.addEventListener('click', () => {
      if (locked) return;
      submitBackdrop.style.display = 'flex';
    });

    cancelSubmit.addEventListener('click', () => {
      submitBackdrop.style.display = 'none';
    });

    confirmSubmit.addEventListener('click', async () => {
      const payload = buildAttendanceJson();
      console.log('SUBMIT:', payload);

      locked = true;
      statusBadge.textContent = 'üîí Locked';
      await saveDraftLocal();

      submitBackdrop.style.display = 'none';

      [isOnlineChk, notes, search, allP, allA, reset, submitBtn].forEach(el => el.disabled = true);

      status.textContent = isOnline ? '‚úÖ Submitted successfully!' : 'üü° Saved offline, will submit when online.';
      submitBtn.innerHTML = '<span>‚úì</span><div>Submitted (Locked)</div>';

      try {
        await db.saveSubmission({
          id: Date.now().toString(),
          payload,
          syncedAt: Date.now(),
          status: isOnline ? 'synced' : 'pending'
        });
      } catch (e) {
        console.warn('Submission save failed:', e);
      }
    });

    userBtn.addEventListener('click', () => {
      const msg = `Profile: ${currentUser.email}\nCourse: ${rosterMeta.courseId}\nSection: ${rosterMeta.section}\nStatus: ${isOnline ? 'üü¢ Online' : 'üü° Offline'}\n\nClick OK to logout`;
      if (confirm(msg)) {
        logoutCR();
      }
    });

    analyticsBtn.addEventListener('click', () => {
      analyticsCard.style.display = analyticsCard.style.display === 'none' ? 'block' : 'none';
      if (analyticsCard.style.display === 'block') {
        const ctx = document.getElementById('attendanceChart').getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Session 1', 'Session 2', 'Session 3', 'Session 4', 'Session 5'],
            datasets: [
              {
                label: 'Present',
                data: [24, 22, 25, 23, 24],
                backgroundColor: 'rgba(34, 194, 107, 0.2)',
                borderColor: 'rgb(34, 194, 107)',
                borderWidth: 1
              },
              {
                label: 'Absent',
                data: [2, 4, 1, 3, 2],
                backgroundColor: 'rgba(189, 56, 80, 0.2)',
                borderColor: 'rgb(189, 56, 80)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              y: { beginAtZero: true, max: 28 }
            }
          }
        });
      }
    });

    syncRosterBtn.addEventListener('click', () => {
      syncRoster();
    });

    window.addEventListener('online', () => {
      isOnline = true;
      setNet();
      status.textContent = 'üü¢ Online! Syncing pending submissions...';
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      setNet();
    });

    // =====================
    // INITIALIZATION
    // =====================
    (async () => {
      try {
        setTodayDate();
        await db.init();
        setNet();

        // Check if CR is already logged in
        if (loadCRFromStorage()) {
          loginBackdrop.style.display = 'none';
          await initRoster();
          await restoreDraftLocal();
          render();
          console.log('‚úÖ App initialized. CR:', currentUser.email);
        } else {
          // Show login modal
          loginBackdrop.style.display = 'flex';
          console.log('üîí CR login required');
        }
      } catch (e) {
        console.error('Init failed:', e);
      }
    })();

    if (supportsPWA()) {
      navigator.serviceWorker.register('./service-worker.js').then(() => {
        console.log('‚úÖ Service Worker registered successfully');
      }).catch(e => {
        console.log('‚ö†Ô∏è SW registration failed:', e.message);
      });
    }
  </script>
</body>

</html>